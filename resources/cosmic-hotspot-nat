#!/bin/bash
# Helper script for cosmic-hotspot NAT setup
# Installed to /usr/local/bin/ and authorized via polkit policy
# Usage: cosmic-hotspot-nat <hotspot_interface> <internet_interface>

set -euo pipefail

if [ $# -ne 2 ]; then
    echo "Usage: $0 <hotspot_interface> <internet_interface>" >&2
    exit 1
fi

HOT="$1"
INET="$2"

# Validate interface names (alphanumeric + underscore only)
if [[ ! "$HOT" =~ ^[a-zA-Z0-9_]+$ ]] || [[ ! "$INET" =~ ^[a-zA-Z0-9_]+$ ]]; then
    echo "Invalid interface name" >&2
    exit 1
fi

sysctl -w net.ipv4.ip_forward=1 > /dev/null

iptables -t nat -C POSTROUTING -o "$INET" -j MASQUERADE 2>/dev/null \
    || iptables -t nat -A POSTROUTING -o "$INET" -j MASQUERADE

iptables -C FORWARD -i "$HOT" -o "$INET" -j ACCEPT 2>/dev/null \
    || iptables -A FORWARD -i "$HOT" -o "$INET" -j ACCEPT

iptables -C FORWARD -i "$INET" -o "$HOT" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null \
    || iptables -A FORWARD -i "$INET" -o "$HOT" -m state --state RELATED,ESTABLISHED -j ACCEPT
